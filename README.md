# Postgres. Визуализация B-Tree индексов

![simple index](/sample/image2023-8-14_16-27-48.png)

## Предыстория

Нам для задачи потребовалось проанализировать поврежденный индекс, чтобы как то упростить себе задачу был написан простенький скрипт для генерации dot файла.

## Step-by-step

1. Получить файл индекса.
2. С помощью [pg_filedump](https://wiki.postgresql.org/wiki/Pg_filedump) и опций -i -f необходимо получить файл, который потом будет разбираться скриптом.
   1. Пример: pg_filedump -i -f 2806156197 > pgfiledump.txt
3. С помощью скрипта pg_b_tree_visualization.py получить dot файл result.dot
   1. Пример: python3 pg_b_tree_visualization.py ./txt/pgfiledump.txt
4. Получить svg файл с помощью [graphviz](https://graphviz.org/)
   1. Пример:  dot -Tsvg result.dot > output.svg

## Описание вывода

Выводится несколько уровней блоков, с лева направо:

1. Самый левый - это корень
2. Самый правый(Уровень 0) - это листы дерева


Могут встречаться серые блоки - это блоки, которые помечены как удалённые, но на них, по каким то причинам, всё ещё ссылаются.

Внутри блоков представлена информация о номере блока и элементах индекса. Элементы индекса ссылаются на другие блоки. В последнем уровне(уровень 0) не отображаются элементы т.к. они ссылаются на кортежи и это сильно засоряет вывод.

Соединения бывают 3х видов:

1. Чёрные стрелки - соединяют элементы индекса с блоками, на которые элемент ссылается
2. Красные стрелки - ссылка на предыдущий блок(Previous)
3. Зелёные стрелки - ссылка на следующий блок(Next)

## Ограничения
1. Совсем поломанные индексы не получится визуализацировать. Необходимо проверить, чтобы файл сгенерированный [pg_filedump](https://wiki.postgresql.org/wiki/Pg_filedump) был содержательный
2. Для работы программы требуется [pg_filedump](https://wiki.postgresql.org/wiki/Pg_filedump) и [graphviz](https://graphviz.org/)